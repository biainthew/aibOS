---
layout: post
title: "시스템 구조, 로그,모니터링 개념 정리"
date: 2026-02-03
categories: [general]
tags: [Infra]
excerpt_separator: ""
---



### 정리를 하게 된 이유


JMeter를 사용해서 부하 테스트를 하다가 스레드 50, 반복 5 설정에서 서버가 죽는 현상이 발생했다


CPU, DB 사용량은 낮았는데 장애가 났고 로그 확인 결과 원인은 DB 커넥션 풀 부족이었다


이 과정에서 서버가 여러 대일 때 요청 흐름이 정확히 어떻게 되는지 WAS, DB, LB, 로그, 에이전트, APM, 중앙 로그 시스템이 각각 어떤 역할을 하는지 궁금해져서 개념 정리를 하게 되었다


### 1. 전체 요청 흐름

1. 클라이언트가 요청을 보냄
2. 로드밸런서가 요청을 받음
3. 로드밸런서가 살아있는 서버 중 하나로 요청 전달
4. 해당 서버의 WAS에서 비즈니스 로직 실행
5. 필요 시 DB로 쿼리 요청
6. DB 응답 반환
7. WAS가 클라이언트에 최종 응답 반환

> 💡 **로드 밸런서**  
> 서버로 요청을 분산시켜주는 중간 장치  
>   
> URL은 특정 서버가 아니라 로드 밸런서 주소다 !


### 2. 서버, WAS, 운영 서버간의 관계


**서버 = 운영 서버**

- 물리 서버, VM, 인스턴스, 컨테이너
- CPU, 메모리, 디스크 보유
- 어플리케이션이 실행되는 환경

**WAS(Web application server)**

- 서버 위에서 실행되는 소프트웨어
- HTTP 요청을 받아 어플리케이션 코드 실행
- 예시 : Spring Boot, Tomcat

**관계 정리**

- 서버와 WAS 는 1대 1이 일반적
- 실무에서는 운영서버 = WAS 라고 편의상 말하기도 하나 개념적으로는 다름

### 3. 로드밸런서

- 클라이언트와 서버 사이에 위치
- 요청을 여러 서버로 분산 전달
- 서버 상태 체크(헬스체크)
- 죽은 서버로 요청 전달하지 않음
- 비즈니스 로직 실행하지 않음

> 💡 **만약 모든 서버가 다 죽어있으면 클라이언트가 보낸 요청 로그는 찍히는지 ?**  
> 1. 로드밸런서까지 살아있을 경우  
>   
> - LB로그만 찍힘  
>   
> 1. 로드밸런서도 죽은 경우  
>   
> - 아무 로그도 찍히지 않고 클라이언트쪽 에러만 발생  
>   
> 1. 서버는 OS는 살아있지만 WAS 프로세스만 죽은 경우  
>   
> - LB로그 찍힘  
>   
> - WAS로그 안찍힘  
>   
> - 시스템 로그 찍힘


### 4. 로그의 종류와 위치


어플리케이션 로그(WAS로그)

- 개발자가 코드에서 찍는 로그
- 요청 시작, 로직 처리, 에러 등
- 로컬 실행 시 터미널에서 출력
- 운영 시 서버 파일 또는 컨테이너 stdout에 기록
- 서버별로 따로 쌓임

DB로그

- DB서버에서 생성
- 쿼리 실행, 슬로우쿼리, 락, 커넥션 정보
- WAS 서버에는 없음
- DB 관점의 로그

LB 로그

- 로드밸런서가 생성
- 어떤 요청을 어떤 서버로 보냈는지 기록

컨테이너 로그

- 컨테이너 stdout / stderr
- 어플리케이션 로그 + 시스템 메세지

시스템 로그

- OS 레벨 로그
- 프로세스 종료, 네트워크 오류, 디스크 오류 등

### 5. 로그가 분산되는 경우

- 서버가 여러 대
- 요청이 랜덤으로 서버에 분산
- 동일한 URL요청이라도 로그는 서버별로 나뉘어 기록됨
- DB로그는 WAS로그와 물리적으로 분리됨

> 💡 **로컬에서는 모든 로그가 터미널 하나에 다 출력되는 이유 ?**  
> 왜냐면 로컬에서는 보통 서버 1대, WAS 1개, 로컬 DB 또는 원격 DB지만 콘솔에 로그 출력, 로드 밸런서 없음, 에이전트 없음 상태이기 때문에 내 터미널 하나가 WAS 로그 출력창 역할을 함  
>   
> => 이게 무슨말이냐 ?  
>   
> JPA, MyBatis 등의 설정으로 SQL을 콘솔에 출력하도록 해서 터미널에 쿼리가 찍히는거지 그게 DB로그는 아니고 사실은 ORM이 찍어주는 로그다 ..!


### 6. 에이전트

- 서버에 설치되는 상주 프로그램
- 로그, 메트릭, 트레이스 수집
- 설정된 대상만 수집
- 수집한 데이터를 네트워크로 중앙 서버에 전송

### 7. 중앙 서버

- 에이전트가 전송한 데이터를 저장하는 서버
- 로그, 메트릭, 트레이스를 모아서 관리
- 여러 대 서버로 구성되는 경우가 많음(클러스터)
    - 왜냐면 양이 매우 많기 때문

### 8. 클러스터

- 여러 서버를 묶어 하나의 시스템처럼 운영
- 데이터 분산 저장
- 장애 발생 시 일부 서버가 죽어도 전체 서비스 유지
- 확장성 확보

### 9. 로그, 트레이스, 메트릭 차이


**로그**

- 사건 기록
- 텍스트 기반
- 사후 분석용

**트레이스**

- 요청 하나의 전체 흐름
- 정상 요청도 포함
- 어디서 지연, 병목이 발생했는지 확인

**메트릭**

- 숫자로 집계된 상태 값
- CPU, 메모리, 응답시간, 커넥션 수 등
- 실시간 감시 및 알림용

### 10. APM(Application Performance Monitoring)

- 요청 흐름, 성능 자동 추적 도구
- WAS에 붙는 에이전트 또는 라이브러리 + 중앙 APM 서버
- 트레이스 + 메트릭 중심
- 예 : Pinpoint, Scounter, Datadog

### 11. 미들웨어, 인터셉터, AOP


**미들웨어**

- 요청 처리 중간에 공통 로직 수행
- 인증, 로깅, 트랜잭션 처리 등

**인터셉터**

- 미들웨어 구현 방식 중 하나
- 컨트롤러 전/후에 실행
- 요청 단위 처리 제어

**AOP**

- 메서드의 특정 시점에 코드 삽입
- 미들웨어에서 하는 일을 AOP로 구현

### 12. 장애 관련 주요 용어


**커넥션 풀**

- DB 연결을 미리 생성해 재사용
- max 초과 시 요청 대기
- CPU, DB 사용량이 낮아도 장애 발생 가능

**락**

- 동시에 접근하지 못하게 제어
- DB락, 어플리케이션 락

**OOM(Out Of Memory)**

- 메모리 부족
- OS 또는 JVM이 프로세스를 강제 종료
