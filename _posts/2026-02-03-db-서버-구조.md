---
layout: post
title: "DB 서버 구조"
date: 2026-02-04
categories: [general]
tags: [Infra]
excerpt_separator: ""
---



### DB도 서버가 여러 개일 수 있는지 ?


가능하고 흔함


### DB 서버 종류

1. **단일 DB 서버**
    1. DB 서버 한 대
    2. read / write 전부 처리
    3. 트래픽 증가 시 바로 병목현상 발생
2. **Master / Replica**
    1. DB 서버 여러 대(Master : write, Replica : read)
    2. 데이터는 Master → Replica 로 복제
        1. 여기서 지연이 발생한다 
        → 운영 DB 데이터 변경 후 화면에 바로 반영되지 않았던게 이것 때문
    3. 어플리케이션에서는 논리적으로 하나의 DB처럼 사용
3. **Multi Master**
    1. 여러 DB가 write 가능
    2. 동기화 복잡
    3. 일반 서비스에서는 거의 사용하지 않음
4. **Sharding**
    1. 데이터 자체를 나눔
    2. 각 DB는 일부 데이터만 가짐
    3. 대규모 서비스에서 사용

> 💡 **그럼 디비버에서 보는 주소는 뭔지 ?**  
> → 보통 DB 서버 주소  
>   
> - 단일 DB일 경우 : 주소 한 개  
>   
> - Master / Replica 일 경우 : write 주소 한 개, read 주소 여러 개 또는 LB 주소 한 개


### 여러 WAS에서 DB 요청이 처리되는 실제 구조

- WAS는 여러 대일 수 있음
- DB 커넥션 풀은 WAS**마다 따로 있음**
    - 예 : WAS 1대당 max 10

### DB 서버 선택 방식


**WRITE 요청**

- 항상 Master DB로만 전송

**READ 요청**

- DB 앞단의 로드 밸런서가 Replica로 분산
- 또는 애플리케이션 설정에 따라 read 전용 DataSource로 분기

### 처리 과정

- WAS 여러 대, 풀은 각 WAS 안에서만 10개
    - 특정 순간에 한 WAS로 요청 쏠릴 수도 있음
- 모두 같은 DB에 연결
- DB 입장에서는 여러 클라이언트가 동시에 접속한게 됨
- 동시에 10개 이상의 요청이 DB 커넥션을 잡으려고 하면

    → 대기 → 타임아웃 → 에러


### 왜 특정 WAS로 요청이 쏠릴 수 있는지 ?


부하 테스트나 실서비스 환경에서 요청은 항상 WAS에 균등 분산되지 않음


**1. 로드 밸런서 분산 알고리즘 한계**

- Round Robin, Least Connection 모두 **순간 트래픽에는 완전하지 않음**
- 요청 처리 시간이 긴 WAS는 커넥션이 오래 남아 불균형 발생

**2. Keep-Alive / 커넥션 재사용**

- 클라이언트 ↔ LB ↔ WAS 사이 TCP 커넥션을 재사용
- 한 번 연결된 WAS로 **연속 요청이 계속 전달됨**
- JMeter 같은 부하 테스트 도구에서 특히 심함

**3. 세션 고정 (Sticky Session)**

- 로그인, 세션 기반 서비스의 경우
- 특정 클라이언트 요청이 **항상 같은 WAS로 라우팅**
- 의도된 구조지만 부하 테스트 시 한 WAS 과부하 원인이 됨

**4. WAS 상태 차이**

- 일부 WAS가 GC 중 응답 지연
- 로드 밸런서가 상대적으로 빠른 WAS로만 요청 전달

    → 특정 WAS 집중


**5. 헬스 체크 타이밍 문제**

- 헬스 체크 주기가 느리면
    - 실제로는 불안정한 WAS로도 요청 전달
- 정상 WAS 수가 줄어들며 쏠림 발생

**6. 부하 테스트 특성**

- JMeter는 동일 패턴, 동일 커넥션, 짧은 시간에 집중 요청

    → 실제 사용자 트래픽보다 쏠림이 과장됨

