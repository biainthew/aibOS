---
layout: post
title: "MERGE"
date: 2025-01-16
categories: [general]
tags: [Sql]
excerpt_separator: ""
---



### 기본 구문


```sql
MERGE INTO 테이블1
USING 테이블2
ON 조건
WHEN MATCHED THEN
	UPDATE SET
		테이블1.컬럼1 = 테이블2.컬럼1
		테이블1.컬럼2 = 테이블2.컬럼2
WHEN NOT MATCHED THEN
	INSERT (컬럼1, 컬럼2)
	VALUES (테이블2.컬럼1, 테이블2.컬럼2)
```


> 💡 **UPSERT** ❓  
> 데이터가 있으면 UPDATE 없으면 INSERT


### 언제 쓰냐 ?

1. **데이터 동기화**

    하나의 테이블을 기준으로 다른 테이블의 데이터를 최신 상태로 유지할 때

2. **조건부 UPSERT**

    대량 데이터를 처리할 때 조건에 따라 효율적으로 삽입 또는 갱신


### 주의사항

1. ON 조건이 중요

    정확한 매칭 조건이 없으면 모든 데이터가 잘못 업데이트 또는 삽입 될 수 있음

2. UNIQUE 제약 조건 확인

    중복 데이터가 발생하지 않도록 조건을 잘 확인해야 함

3. Performance

    대량 데이터 처리 시 성능이 중요하므로 인덱스 최적화가 필요함


    > 💡 **인덱스 최적화** ❓  
    > DB에서 쿼리 성능 향상을 위해 인덱스를 효과적으로 설계, 관리, 사용하는 방법으로  
    >   
    > 1. 조회 빈도가 높은 컬럼에 인덱스를 생성  
    >   
    > 2. 중복이 적고 가능한 많은 행을 걸러낼 수 있는 컬럼에 인덱스를 생성 (예. 주민등록번호 등)  
    >   
    > 3. 자주 함께 조회되는 컬럼을 결합한 인덱스를 생성  
    >   
    > 4. 인덱스가 많을수록 데이터 변경작업(IUD)이 느려지므로 과도한 생성 피하기  
    >   
    > 5. 인덱스 상태를 주기적으로 점검해서 사용되지 않으면 제거


### 단일 테이블에서도 사용 가능 ? > O


```sql
MERGE INTO BSSC.AM_OPINION_ITEM aoi 
USING DUAL
ON aoi.MANDT = '100'
AND aoi.BUKRS = '1000'
AND aoi.OPINOFE_NO = 'ab2b7f26-02db-4ac7-b'
AND aoi.MATER_NO = '2'
AND aoi.EL_NO = '123456'
WHEN MATCHED THEN
	UPDATE SET
	aoi.CAR_NO = '호기번호수정2'
WHEN NOT MATCHED THEN
	INSERT aoi.CAR_NO
	VALUES '호기번호수정2'
```


> 💡 **DUAL** ❓  
> 오라클에서 제공하는 단일 행을 가진 가상 테이블로 SELECT 문에서 임시 데이터를 생성하거나 계산을 수행할 때 사용됨  
>   
> **사용 예시**  
>   
> 1. 값 계산 및 반환 `SELECT 1 + 2 AS result FROM DUAL;`  
>   
> 2. 현재 날짜 및 시간 확인 `SELECT SYSDATE AS current_date FROM DUAL;`  
>   
> 3. 상수 데이터 반환 `SELECT 'Hello, World!' AS message FROM DUAL;`  
>   
> 4. 함수 테스트 `SELECT LENGTH('Oracle') AS string_length FROM DUAL;`  
>   
> **사용 이유**  
>   
> 1. 표준 SQL에서는 테이블 없이 단순 SQL을 실행할 수 없기 때문에 오라클에서 DUAL을 통해 이를 해결함  
>   
> 2. 테이블 기반 쿼리 구조를 유지하면서도 단순 작업을 수행할 수 있음  
>   
> 3. DB레벨에서 값 계산 및 데이터 생성이 필요할 때 사용

