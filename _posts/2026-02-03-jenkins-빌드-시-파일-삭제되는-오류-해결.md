---
layout: post
title: "Jenkins 빌드 시 파일 삭제되는 오류 해결"
date: 2026-01-05
categories: [general]
tags: [Infra]
excerpt_separator: ""
---



### 문제


Jenkins Pipeline을 통해 자동 배포가 되도록 설정을 해두었는데 개발서버가 빌드 될 때마다 운영에 필요한 `files/` 하위 디렉토리의 파일들이 모두 삭제됨


파일이 서버에 업로드 된 것은 분명히 확인했고 서버 빌드 이후 파일이 삭제되는 것도 확인해서 원인분석을 시작함


### 원인 분석

1. **기존 설정의 문제**

    원래 `Jenkinsfile`에는 빌드 시작 전 워크스페이스를 깨끗하게 비우는 아래 명령어가 포함되어 있었음


    {% raw %}
```bash
    # 워크스페이스 내의 모든 파일과 폴더를 삭제
    find . -mindepth 1 -delete 2>/dev/null || rm -rf ./* ./.[!.]* 2>/dev/null || true
    ```
{% endraw %}

2. **1차 수정 시도(실패)**

    `files` 폴더만 빼고 지우기 위해 아래와 같이 수정해봄


    {% raw %}
```bash
    find . -mindepth 1 -not -path './files*' -delete 2>/dev/null || true
    ```
{% endraw %}


    **결과** : `files` 폴더는 남아있었지만 이후 git clone 단계에서 `fatal: destination path '.' already exists and is not an empty directory.` 에러가 발생하며 빌드가 중단됨


    **이유** : 깃은 대상 폴더가 완전히 비어있지 않으면 보안상 새로 코드를 clone 하지 않음(그래서 위의 워크스페이스 내 모든 파일과 폴더를 삭제하는 로직이 들어있던 것으로 추정됨)

3. **최종 해결 방안**

    {% raw %}
```bash
    # 1. 현재 폴더를 Git 저장소로 초기화
    git init
    
    # 2. 원격 저장소 연결
    git remote add origin "${GIT_AUTH_URL}" || git remote set-url origin "${GIT_AUTH_URL}"
    
    # 3. 필요한 브랜치의 최신 이력만 가져오기
    git fetch --depth 1 origin "${GIT_BRANCH}"
    
    # 4. 가져온 소스로 강제 체크아웃
    git checkout -f FETCH_HEAD
    ```
{% endraw %}


    결국 `git clone` 대신 `git init, fetch` 방식으로 변경


> 💡 **혹시 서버에서 코드를 수정했다면 충돌이 날 가능성은 없는지 ?**  
> checkout -f 옵션을 사용해서 서버의 로컬 변경사항은 무시하고 원격 저장소의 코드로 강제 업데이트함 따라서 코드 충돌로 빌드가 실패할 일은 없음

